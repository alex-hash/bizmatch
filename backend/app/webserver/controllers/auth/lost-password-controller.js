'use strict';


const Joi = require('@hapi/joi');
const mysqlPool = require('../../../database/mysql-pool');
const sendgridMail = require('@sendgrid/mail');
const base64 = require('js-base64').Base64;

sendgridMail.setApiKey(process.env.SENDGRID_API_KEY);

async function sendLostPasswordEmail(email, old_password) {
  const urlvars = base64.encode(`:${email}:${old_password}`);
  const msg = {
    to: email,
    from: 'bizmatchapp@yopmail.com',
    subject: 'Email to change password',
    text: `Hello, this a email autogenerated to change your password`,
    html: `<strong>Hello, this a email autogenerated to change your password <a href="${process.env.HTTP_SERVER_DOMAIN}/${urlvars}">Change your password</a></strong>`,
  };

  const data = await sendgridMail.send(msg);
  console.log(data);

  return data;
}

async function validateEmail(data) {
    const schema = Joi.object({
      email: Joi.string().email({ minDomainSegments: 2, tlds: false }).required(),
    });
  
    Joi.assert(data, schema);
  }

async function lostPassword(req, res, next){
    const accountData = { ...req.body }

    try {
        await validateEmail(accountData);
    } catch (e) {
        console.error(e);
        return res.status(400).send(e);
    }

    let connection;
    try{
        const sqlQuery = `SELECT password
        FROM user
        WHERE email = ?`;

        connection = await mysqlPool.getConnection();
        const [rows] = await connection.execute(sqlQuery, [accountData.email]);
        connection.release();

        if(rows.length !== 1){
            return res.status(404).send();
        }

        res.status(204).send();

        try{
            await sendLostPasswordEmail(accountData.email, rows[0].password);
        } catch(e) {
            console.error(e);
        }
    } catch(e){
        if (connection) {
            connection.release();
        }
        console.error(e);
        return res.status(500).send();
    }
}

module.exports = lostPassword;